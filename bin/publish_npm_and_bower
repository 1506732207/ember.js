#!/usr/bin/env bash

git config --global user.email "tomster@emberjs.com"
git config --global user.name "Tomster"

echo -e "CURRENT_BRANCH: ${TRAVIS_BRANCH}\n"
echo -e "CURRENT_TAG: ${TRAVIS_TAG}\n"

if [[ $TRAVIS_PULL_REQUEST != "false" ]]; then
  echo "not publishing because this is a pull request."
  exit 0
fi

# Set channel to publish to.  If no suitable branch is found, exit successfully.
case $TRAVIS_BRANCH in
  "master" )
    CHANNEL="canary" ;;
  "beta" )
    CHANNEL="beta" ;;
  "release" )
    CHANNEL="release" ;;
  "lts-2-4" )
    CHANNEL="lts-2-4" ;;
  "release-1-13" )
    CHANNEL="release-1-13" ;;
  * )
    if [[ "$TRAVIS_TAG" != "" ]]; then
      case "$TRAVIS_TAG" in
        *alpha* )
          CHANNEL="canary" ;;
        *beta* )
          CHANNEL="beta" ;;
        * )
          CHANNEL="release" ;;
      esac
    else
      echo "Not a bower release branch or tag.  Exiting!"
      exit 0
    fi
esac
echo -e "CHANNEL: ${CHANNEL}\n"

if [[ -n $BUILD_TYPE ]]; then
  CHANNEL=$BUILD_TYPE
  echo -e "CHANNEL OVERRIDE: ${CHANNEL}\n"
fi

#### NPM PUBLISHING

if [[ "$TRAVIS_TAG" =~ ^v[0-9.]+ ]]; then
  echo $NPM_AUTH_TOKEN > ~/.npmrc

  NPM_USER=`npm whoami`
  echo -e "Publishing to npm as $NPM_USER...\n"

  if [[ "$CHANNEL" == "release" ]]; then
    npm publish
  else
    npm publish --tag $CHANNEL
  fi
fi

#### RUBYGEMS PUBLISHING

if [[ "$TRAVIS_TAG" =~ ^v[0-9.]+ ]]; then
  echo -e "Publishing to RubyGems...\n"

  mkdir -p ~/.gem
  echo $RUBYGEMS_AUTH_TOKEN > ~/.gem/credentials
  chmod 0600 ~/.gem/credentials

  gem build ember-source.gemspec
  gem push `echo *.gem`
fi
